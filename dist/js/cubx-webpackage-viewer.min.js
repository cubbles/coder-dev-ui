/*! cubx-webpackage-viewer 03-05-2016 */
"use strict";var WebpackageViewer=function(a,b){this.structureHolderId=a,this.dataflowHolderId=b,this.dataflowViewWidth=800,this.dataflowViewHeight=500};WebpackageViewer.prototype.constructor=WebpackageViewer,WebpackageViewer.prototype.loadStructureView=function(a){this.setStructureViewOptions(),this.structureView=new JSONEditor(document.getElementById(this.structureHolderId),{theme:"bootstrap3",iconlib:"bootstrap3",disable_array_reorder:!0,no_additional_properties:!0,disable_edit_json:!0,disable_properties:!0,keep_oneof_values:!1,schema:a})},WebpackageViewer.prototype.setStructureViewOptions=function(){JSONEditor.defaults.editors.array.options.collapsed=!0,JSONEditor.defaults.editors.table.options.collapsed=!0},WebpackageViewer.prototype.loadManifest=function(){var a=this;$.getJSON(this.$_GET("webpackage"),function(b){a.structureView.setValue(b),$('[data-toggle="popover"]').popover(),a.addViewDataflowButtons()})},WebpackageViewer.prototype.loadSchema=function(){var a=this;$.getJSON(this.$_GET("schema"),function(b){var c=b;for(var d in c.properties.artifacts.properties)c.properties.artifacts.properties[d].format="tabs";c.properties.contributors.format="table",c.properties.author.format="grid";var e=["appArtifact","elementaryArtifact","compoundArtifact"];for(var f in e)c.definitions[e[f]].properties.runnables.format="table",c.definitions[e[f]].properties.endpoints.format="tabs";c.definitions.elementaryArtifact.properties.slots.format="tabs",c.definitions.compoundArtifact.properties.slots.format="tabs",c.definitions.compoundArtifact.properties.members.format="table",c.definitions.compoundArtifact.properties.connections.format="tabs",c.definitions.compoundArtifact.properties.inits.format="table",a.loadStructureView(c)})},WebpackageViewer.prototype.$_GET=function(a){var b={};return window.location.href.replace(location.hash,"").replace(/[?&]+([^=&]+)=?([^&]*)?/gi,function(a,c,d){b[c]=void 0!==d?d:""}),a?b[a]?b[a]:null:b},WebpackageViewer.prototype.addViewDataflowButtons=function(){var a,b,c,d=this.structureView.getValue().artifacts.compoundComponents,e=this.dataflowHolderId,f=this;for(var g in d)a=document.createElement("button"),a.setAttribute("type","button"),a.setAttribute("class","btn btn-primary"),a.setAttribute("data-toggle","modal"),a.setAttribute("data-compound-index",g),b=document.createElement("i"),b.setAttribute("class","glyphicon glyphicon-eye-open"),a.appendChild(b),a.appendChild(document.createTextNode("View diagram")),a.onclick=function(){var a=$("#"+e);f.drawDataflow(f.generateDataflowGraph($(this).attr("data-compound-index"),f.structureView.getValue())),a.modal("show")},c=$('[data-schemapath="root.artifacts.compoundComponents.'+g+'"]').find("label:first"),c.append(a)},WebpackageViewer.prototype.generateDataflowGraph=function(a,b){var c={id:"root",children:[]},d=b.artifacts.compoundComponents[a],e=this.generateGraphMember(d,d.artifactId,{portLabelPlacement:"OUTSIDE",borderSpacing:40});return e.children=this.generateGraphMembers(d.members,b),c.children.push(e),c.edges=this.generateGraphConnections(d.connections,d.artifactId),c},WebpackageViewer.prototype.generateGraphMembers=function(a){var b,c,d=[];for(var e in a)c=this.componentDefinitionOfMember(a[e]),b=this.generateGraphMember(c,a[e].memberId),d.push(b);return d},WebpackageViewer.prototype.generateGraphMember=function(a,b,c){var d=this.generateGraphMemberSlots(a,b),e=7*a.artifactId.length,f={id:b,labels:[{text:a.artifactId,width:e,height:10}],width:Math.max(2*d.maxSlotWidth+20,e),height:15*d.slots.length+40,ports:d.slots,properties:{portConstraints:"FIXED_SIDE",portLabelPlacement:c?c.portLabelPlacement:"INSIDE",nodeLabelPlacement:"INSIDE H_CENTER V_TOP",portAlignment:"CENTER",portSpacing:3,borderSpacing:c?c.borderSpacing:12}};return f},WebpackageViewer.prototype.generateGraphMemberSlots=function(a,b){var c,d,e=[],f=0;for(var g in a.slots)for(var h in a.slots[g].direction)d=5*a.slots[g].slotId.length,f=Math.max(d,f),c=this.generateGraphMemberSlot(a.slots[g].slotId,b,a.slots[g].direction[h],d),e.push(c);return{slots:e,maxSlotWidth:f}},WebpackageViewer.prototype.generateGraphMemberSlot=function(a,b,c,d){var e={id:a+"_"+b+"_"+c,properties:{portSide:"input"===c?"WEST":"EAST"},labels:[{text:a,width:d,height:10}],height:10};return e},WebpackageViewer.prototype.generateGraphConnections=function(a,b){var c,d=[];for(var e in a)c=this.generateGraphConnection(a[e],b),d.push(c);return d},WebpackageViewer.prototype.generateGraphConnection=function(a,b){var c,d=a.source.slot+"_";a.source.memberIdRef?(c=a.source.memberIdRef,d+=a.source.memberIdRef+"_output"):(c=b,d+=b+"_input");var e,f=a.destination.slot+"_";a.destination.memberIdRef?(e=a.destination.memberIdRef,f+=a.destination.memberIdRef+"_input"):(e=b,f+=b+"_output");var g={id:a.connectionId,labels:[{text:a.connectionId,width:5*a.connectionId.length,height:10}],source:c,sourcePort:d,target:e,targetPort:f};return g},WebpackageViewer.prototype.componentDefinitionOfMember=function(a){var b,c="https://cubbles.world/sandbox/",d=a.componentId.substr(a.componentId.indexOf("/")+1);if(a.componentId.includes("this/"))b=this.searchComponentInManifest(d,this.structureView.getValue());else{var e=this,f=c+a.componentId.substr(0,a.componentId.indexOf("/"));$.ajaxSetup({async:!1}),$.getJSON(f,function(a){b=e.searchComponentInManifest(d,a)}),$.ajaxSetup({async:!0})}return b},WebpackageViewer.prototype.searchComponentInManifest=function(a,b){var c=this.searchComponentIn(a,b.artifacts.elementaryComponents);return c||(c=this.searchComponentIn(a,b.artifacts.compoundComponents)),c},WebpackageViewer.prototype.searchComponentIn=function(a,b){for(var c in b)if(b[c].artifactId===a)return b[c];return!1},WebpackageViewer.prototype.drawDataflow=function(a){d3.select("#"+this.dataflowHolderId).select(".modal-body").html("");var b=this,c=d3.behavior.zoom().on("zoom",function(){b.svg.attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")});this.svg=d3.select("#"+this.dataflowHolderId).select(".modal-body").append("svg").attr("width","100%").attr("height",this.dataflowViewHeight).call(c).append("g");var d=this.svg.append("g"),e=klay.d3kgraph().size([this.dataflowViewWidth,this.dataflowViewHeight]).transformGroup(d).options({layoutHierarchy:!0,intCoordinates:!0,direction:"RIGHT",edgeRouting:"ORTHOGONAL",nodeLayering:"NETWORK_SIMPLEX",nodePlace:"BRANDES_KOEPF",crossMin:"LAYER_SWEEP",algorithm:"de.cau.cs.kieler.klay.layered"});e.on("finish",function(a){var c=e.nodes(),f=e.links(c),g=d.selectAll(".node").data(c,function(a){return a.id}),h=d.selectAll(".link").data(f,function(a){return a.id});b.drawComponents(g),b.drawComponentsSlots(g),b.drawConnections(h)}),e.kgraph(a)},WebpackageViewer.prototype.drawComponents=function(a){var b=a.enter().append("g").attr("class",function(a){return a.children?"componentView compound":"componentView leaf"}),c=b.append("rect").attr("class","componentViewAtom");b.transition().attr("transform",function(a){return"translate("+(a.x||0)+" "+(a.y||0)+")"}),c.transition().attr("width",function(a){return a.width}).attr("height",function(a){return a.height});var d=b.selectAll(".componentViewLabel").data(function(a){return a.labels||[]}).enter().append("text").text(function(a){return a.text}).attr("class","componentViewLabel");d.transition().attr("height",function(a){return a.height}).attr("width",function(a){return a.width}),d.transition().attr("x",function(a){return a.x}).attr("y",function(a){return a.y+a.height})},WebpackageViewer.prototype.drawComponentsSlots=function(a){var b=a.selectAll(".slotView").data(function(a){return a.ports||[]}).enter().append("g").attr("class","slotView");b.append("circle").attr("class","slotViewAtom");var c=b.selectAll(".slotViewLabel").data(function(a){return a.labels}).enter().append("text").text(function(a){return a.text}).attr("class","slotViewLabel");b.transition().attr("transform",function(a){return"translate("+(a.x||0)+" "+(a.y||0)+")"}),c.transition().attr("x",function(a){return a.x}).attr("y",function(a){return a.y+3})},WebpackageViewer.prototype.drawConnections=function(a){this.svg.append("svg:defs").selectAll("marker").data(["end"]).enter().append("svg:marker").attr("id",String).attr("class","arrowEnd").attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",5).attr("markerHeight",5).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5");var b=a.enter().append("path").attr("class","connectionView").attr("d","M0 0").attr("marker-end","url(#end)"),c=a.enter().append("text").attr("class","connectionViewLabel").text(function(a){return a.labels[0].text||""});b.transition().attr("d",function(a){var b="";return b+="M"+(a.sourcePoint.x+5)+" "+(a.sourcePoint.y-5)+" ",(a.bendPoints||[]).forEach(function(a,c){b+="L"+a.x+" "+(a.y-5)+" "}),b+="L"+(a.targetPoint.x-5)+" "+(a.targetPoint.y-5)+" "}),c.transition().attr("x",function(a){return a.labels[0].x}).attr("y",function(a){return a.labels[0].y+2.2*a.labels[0].height})};