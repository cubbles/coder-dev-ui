/*! cubx-webpackage-viewer 02-05-2016 */
"use strict";var WebpackageViewer=function(a,b){this.structureHolderId=a,this.dataflowHolderId=b,this.dataflowViewWidth=800,this.dataflowViewHeight=500;var c=this,d=d3.behavior.zoom().on("zoom",function(){c.svg.attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")});this.svg=d3.select("#"+this.dataflowHolderId).select(".modal-body").append("svg").attr("width","100%").attr("height",this.dataflowViewHeight).call(d).append("g")};WebpackageViewer.prototype.constructor=WebpackageViewer,WebpackageViewer.prototype.loadStructureView=function(a){this.setStructureViewOptions(),this.structureView=new JSONEditor(document.getElementById(this.structureHolderId),{theme:"bootstrap3",iconlib:"bootstrap3",disable_array_reorder:!0,no_additional_properties:!0,disable_edit_json:!0,disable_properties:!0,keep_oneof_values:!1,schema:a})},WebpackageViewer.prototype.setStructureViewOptions=function(){JSONEditor.defaults.editors.array.options.collapsed=!0,JSONEditor.defaults.editors.table.options.collapsed=!0},WebpackageViewer.prototype.loadManifest=function(){var a=this;$.getJSON(this.$_GET("webpackage"),function(b){a.structureView.setValue(b),$('[data-toggle="popover"]').popover(),a.addViewDataflowButtons()})},WebpackageViewer.prototype.loadSchema=function(){var a=this;$.getJSON(this.$_GET("schema"),function(b){var c=b;for(var d in c.properties.artifacts.properties)c.properties.artifacts.properties[d].format="tabs";c.properties.contributors.format="table",c.properties.author.format="grid";var e=["appArtifact","elementaryArtifact","compoundArtifact"];for(var f in e)c.definitions[e[f]].properties.runnables.format="table",c.definitions[e[f]].properties.endpoints.format="tabs";c.definitions.elementaryArtifact.properties.slots.format="tabs",c.definitions.compoundArtifact.properties.slots.format="tabs",c.definitions.compoundArtifact.properties.members.format="table",c.definitions.compoundArtifact.properties.connections.format="tabs",c.definitions.compoundArtifact.properties.inits.format="table",a.loadStructureView(c)})},WebpackageViewer.prototype.$_GET=function(a){var b={};return window.location.href.replace(location.hash,"").replace(/[?&]+([^=&]+)=?([^&]*)?/gi,function(a,c,d){b[c]=void 0!==d?d:""}),a?b[a]?b[a]:null:b},WebpackageViewer.prototype.addViewDataflowButtons=function(){var a,b,c,d=this.structureView.getValue().artifacts.compoundComponents,e=this.dataflowHolderId,f=this;for(var g in d)a=document.createElement("button"),a.setAttribute("type","button"),a.setAttribute("class","btn btn-primary"),a.setAttribute("data-toggle","modal"),a.setAttribute("data-compound-index",g),b=document.createElement("i"),b.setAttribute("class","glyphicon glyphicon-eye-open"),a.appendChild(b),a.appendChild(document.createTextNode("View diagram")),a.onclick=function(){var a=$("#"+e);f.drawDataflow(f.generateDataflowGraph($(this).attr("data-compound-index"),f.structureView.getValue())),a.modal("show")},c=$('[data-schemapath="root.artifacts.compoundComponents.'+g+'"]').find("label:first"),c.append(a)},WebpackageViewer.prototype.generateDataflowGraph=function(a,b){var c,d={id:"root",children:[]},e=b.artifacts.compoundComponents[a],f=[];for(var g in e.slots)for(var h in e.slots[g].direction)c={id:e.slots[g].slotId+"_"+e.slots[g].direction[h],properties:{portSide:"input"===e.slots[g].direction[h]?"WEST":"EAST"},labels:[{text:e.slots[g].slotId}],width:10},f.push(c);var i,j,k,l,m,n,o=[];for(var p in e.members){l=[],i=e.members[p].componentId.replace("this/",""),j=e.members[p].memberId,n=this.searchComponentIn(i,b.artifacts.elementaryComponents),n||(n=this.searchComponentIn(i,b.artifacts.compoundComponents));var q,r=0;for(var s in n.slots)for(var t in n.slots[s].direction)q=5*n.slots[s].slotId.length,r=Math.max(q,r),m={id:n.slots[s].slotId+"_"+j+"_"+n.slots[s].direction[t],properties:{portSide:"input"===n.slots[s].direction[t]?"WEST":"EAST"},labels:[{text:n.slots[s].slotId,width:q,height:10}],width:2},l.push(m);var u=7*n.artifactId.length;k={id:j,labels:[{text:n.artifactId,width:u,height:10}],width:Math.max(2*r+20,u),height:15*l.length+40,ports:l,properties:{portConstraints:"FIXED_SIDE",portLabelPlacement:"INSIDE",nodeLabelPlacement:"INSIDE H_CENTER V_TOP",portAlignment:"CENTER",portSpacing:13}},o.push(k)}var v,w=[];for(var x in e.connections){var y,z;e.connections[x].source.memberIdRef?(y=e.connections[x].source.memberIdRef,z=e.connections[x].source.slot+"_"+e.connections[x].source.memberIdRef+"_output"):(y=e.artifactId,z=e.connections[x].source.slot+"_input");var A,B;e.connections[x].destination.memberIdRef?(A=e.connections[x].destination.memberIdRef,B=e.connections[x].destination.slot+"_"+e.connections[x].destination.memberIdRef+"_input"):(A=e.artifactId,B=e.connections[x].destination.slot+"_output"),v={id:e.connections[x].connectionId,labels:[{text:e.connections[x].connectionId,width:5*e.connections[x].connectionId.length,height:10}],source:y,sourcePort:z,target:A,targetPort:B},w.push(v)}var C={id:e.artifactId,labels:[{text:e.artifactId,width:130,height:20}],ports:f,properties:{portConstraints:"FIXED_SIDE",portLabelPlacement:"INSIDE",nodeLabelPlacement:"INSIDE,H_CENTER,V_TOP",portAlignment:"CENTER",portSpacing:13,borderSpacing:40},children:o};return d.children.push(C),d.edges=w,d},WebpackageViewer.prototype.searchComponentIn=function(a,b){for(var c in b)if(b[c].artifactId===a)return b[c];return!1},WebpackageViewer.prototype.drawDataflow=function(a){var b=this.svg.append("g"),c=klay.d3kgraph().size([this.dataflowViewWidth,this.dataflowViewHeight]).transformGroup(b).options({layoutHierarchy:!0,intCoordinates:!0,direction:"RIGHT",edgeRouting:"ORTHOGONAL",nodeLayering:"NETWORK_SIMPLEX",nodePlace:"BRANDES_KOEPF",crossMin:"LAYER_SWEEP",algorithm:"de.cau.cs.kieler.klay.layered"}),d=this;c.on("finish",function(a){var e=c.nodes(),f=c.links(e),g=b.selectAll(".node").data(e,function(a){return a.id}),h=b.selectAll(".link").data(f,function(a){return a.id});d.drawComponents(g),d.drawComponentsSlots(g),d.drawConnections(h)}),c.kgraph(a)},WebpackageViewer.prototype.drawComponents=function(a){var b=a.enter().append("g").attr("class",function(a){return a.children?"componentView compound":"componentView leaf"}),c=b.append("rect").attr("class","componentViewAtom").attr("width",10).attr("height",10);c.transition().attr("width",function(a){return a.width}).attr("height",function(a){return a.height}),b.transition().attr("transform",function(a){return"translate("+(a.x||0)+" "+(a.y||0)+")"});var d=b.selectAll(".componentViewLabel").data(function(a){return a.labels||[]}).enter().append("text").text(function(a){return a.text}).attr("class","componentViewLabel");d.transition().attr("height",function(a){return a.height}),d.transition().attr("x",function(a){return a.x}).attr("y",function(a){return a.y+a.height})},WebpackageViewer.prototype.drawComponentsSlots=function(a){var b=a.selectAll(".slotView").data(function(a){return a.ports||[]}).enter().append("g").attr("class","slotView");b.append("circle").attr("class","slotViewAtom"),b.transition().attr("transform",function(a){return"translate("+(a.x||0)+" "+(a.y||0)+")"});var c=b.selectAll(".slotViewLabel").data(function(a){return a.labels}).enter().append("text").text(function(a){return a.text}).attr("class","slotViewLabel");c.transition().attr("x",function(a){return a.x}).attr("y",function(a){return a.y+7})},WebpackageViewer.prototype.drawConnections=function(a){this.svg.append("svg:defs").selectAll("marker").data(["end"]).enter().append("svg:marker").attr("id",String).attr("class","arrowEnd").attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",5).attr("markerHeight",5).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5");var b=a.enter().append("path").attr("class","connectionView").attr("d","M0 0").attr("marker-end","url(#end)"),c=a.enter().append("text").attr("class","connectionViewLabel").text(function(a){return a.labels[0].text||""});b.transition().attr("d",function(a){var b="";return b+="M"+(a.sourcePoint.x+3)+" "+a.sourcePoint.y+" ",(a.bendPoints||[]).forEach(function(a,c){b+="L"+a.x+" "+a.y+" "}),b+="L"+(a.targetPoint.x-5)+" "+a.targetPoint.y+" "}),c.transition().attr("x",function(a){return a.labels[0].x}).attr("y",function(a){return a.labels[0].y+2.5*a.labels[0].height})};